<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangaToon Downloader</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .manga-info {
            margin-bottom: 20px;
            text-align: center;
        }
        .input-group {
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            width: 100%;
        }
        button:hover {
            background-color: #3a5882;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .loading {
            background-color: #d9edf7;
            color: #31708f;
        }
        .preview-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .manga-image-container {
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 700px;
        }
        .manga-image {
            max-width: 100%;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .download-button {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #5cb85c;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .download-button:hover {
            background-color: #4cae4c;
        }
        .download-all-button {
            background-color: #5cb85c;
            display: none;
            margin-bottom: 20px;
        }
        .disclaimer {
            font-size: 12px;
            color: #777;
            text-align: center;
            margin-top: 30px;
        }
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .github-link {
            text-align: center;
            margin-top: 20px;
        }
        .github-link a {
            color: #4a6fa5;
            text-decoration: none;
        }
        .github-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MangaToon Downloader</h1>
        
        <div class="instructions">
            <p><strong>How to use:</strong></p>
            <ol>
                <li>Enter the manga chapter URL from MangaToon</li>
                <li>Click "Fetch Manga" to retrieve available images</li>
                <li>Images will appear below for viewing and downloading</li>
            </ol>
            <p><em>Note: This tool is for educational purposes. Only download content you have proper rights to access.</em></p>
        </div>
        
        <div class="input-group">
            <input type="text" id="manga-url" placeholder="Enter manga chapter URL (e.g., https://mangatoon.mobi/en/watch/1888729/116936)" 
                   value="https://mangatoon.mobi/en/watch/1888729/116936">
        </div>
        
        <button id="fetch-btn">Fetch Manga</button>
        <div id="loading-spinner" class="loading-spinner"></div>
        
        <div id="status-message" class="status"></div>
        
        <div class="manga-info" id="manga-info"></div>
        
        <button id="download-all-btn" class="download-all-button">Download All Images</button>
        
        <div class="preview-area" id="preview-area">
            <!-- Images will be added here -->
        </div>
        
        <p class="disclaimer">
            This tool is for educational purposes only. Please respect copyright laws and the terms of service
            of the websites you access. Only download content you have proper rights to access.
        </p>
        
        <div class="github-link">
            <a href="https://github.com/yourusername/manga-downloader" target="_blank">View on GitHub</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('manga-url');
            const fetchBtn = document.getElementById('fetch-btn');
            const statusMessage = document.getElementById('status-message');
            const previewArea = document.getElementById('preview-area');
            const mangaInfo = document.getElementById('manga-info');
            const loadingSpinner = document.getElementById('loading-spinner');
            const downloadAllBtn = document.getElementById('download-all-btn');
            
            // Use relative URLs for API endpoints (works with Vercel deployment)
            const API_ENDPOINT = '/api';
            const PROXY_ENDPOINT = '/api/proxy-image';
            
            fetchBtn.addEventListener('click', async () => {
                const url = urlInput.value.trim();
                
                if (!url) {
                    showStatus('Please enter a valid manga chapter URL', 'error');
                    return;
                }
                
                if (!isValidUrl(url)) {
                    showStatus('Invalid URL format. Please enter a valid manga chapter URL', 'error');
                    return;
                }
                
                await fetchMangaChapter(url);
            });
            
            downloadAllBtn.addEventListener('click', () => {
                showStatus('Preparing download for all images...', 'loading');
                
                // Get all download links and trigger them programmatically
                const downloadLinks = document.querySelectorAll('.download-button');
                if (downloadLinks.length > 0) {
                    let delay = 0;
                    downloadLinks.forEach(link => {
                        setTimeout(() => {
                            link.click();
                        }, delay);
                        delay += 500; // Stagger downloads to avoid overwhelming the browser
                    });
                    
                    setTimeout(() => {
                        showStatus('All downloads triggered. Check your downloads folder.', 'success');
                    }, delay);
                }
            });
            
            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }
            
            async function fetchMangaChapter(url) {
                try {
                    showStatus('Fetching manga chapter... Please wait.', 'loading');
                    loadingSpinner.style.display = 'block';
                    fetchBtn.disabled = true;
                    previewArea.innerHTML = '';
                    mangaInfo.innerHTML = '';
                    downloadAllBtn.style.display = 'none';
                    
                    // Make request to our API endpoint
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch manga');
                    }
                    
                    showStatus(`Successfully fetched ${data.totalImages} images!`, 'success');
                    
                    // Display manga info
                    mangaInfo.innerHTML = `
                        <h2>${data.title}</h2>
                        <h3>${data.chapterTitle}</h3>
                        <p>Total Images: ${data.totalImages}</p>
                    `;
                    
                    // Show download all button if we have images
                    if (data.images.length > 0) {
                        downloadAllBtn.style.display = 'block';
                    }
                    
                    // Display images
                    data.images.forEach(image => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'manga-image-container';
                        
                        const img = document.createElement('img');
                        // Use our proxy to avoid CORS issues
                        img.src = `${PROXY_ENDPOINT}?url=${encodeURIComponent(image.url)}`;
                        img.alt = `Page ${image.index}`;
                        img.className = 'manga-image';
                        img.loading = 'lazy'; // Lazy loading for better performance
                        
                        const pageNumber = document.createElement('p');
                        pageNumber.textContent = `Page ${image.index}`;
                        pageNumber.style.fontWeight = 'bold';
                        
                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = `${PROXY_ENDPOINT}?url=${encodeURIComponent(image.url)}`;
                        downloadBtn.download = `page-${image.index}.jpg`;
                        downloadBtn.textContent = `Download Page ${image.index}`;
                        downloadBtn.className = 'download-button';
                        
                        imgContainer.appendChild(pageNumber);
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(downloadBtn);
                        
                        previewArea.appendChild(imgContainer);
                    });
                    
                } catch (error) {
                    showStatus('Error: ' + error.message, 'error');
                    console.error('Error:', error);
                } finally {
                    loadingSpinner.style.display = 'none';
                    fetchBtn.disabled = false;
                }
            }
            
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status ' + type;
                statusMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>
